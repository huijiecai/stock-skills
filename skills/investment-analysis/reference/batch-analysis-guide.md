# 行业-公司批量分析执行指南

> 本指南详细说明了行业分析完成后，如何自动触发并执行批量公司分析的完整流程

---

## 📋 目录

1. [工作流程概览](#工作流程概览)
2. [执行阶段详解](#执行阶段详解)
3. [并行处理配置](#并行处理配置)
4. [错误处理与重试](#错误处理与重试)
5. [质量控制标准](#质量控制标准)

---

## 工作流程概览

### 完整流程图

```
用户触发行业分析
    ↓
[阶段1] 行业分析
    ├─ 收集行业信息
    ├─ 识别所有相关A股公司（15-25家）
    ├─ 按层级和细分领域分类
    └─ 生成行业报告（带占位符链接）
    ↓
[阶段2] 公司批量分析（自动触发）
    ├─ Batch 1: 第一梯队龙头（5-7家）
    ├─ Batch 2: 第二梯队重要企业（8-12家）
    └─ Batch 3: 第三梯队潜力企业（5-8家）
    ↓
[阶段3] 链接更新
    ├─ 扫描生成的公司报告
    ├─ 更新行业报告中的链接
    └─ 添加分析完成标记
    ↓
[阶段4] 概念池更新（自动触发）
    ├─ 批量提取公司-概念关系
    ├─ 调用概念池更新API
    └─ 更新验证状态
    ↓
完成：行业报告 + 公司报告 + 概念池更新
```

### 时间估算

| 阶段 | 预计时间 | 说明 |
|------|----------|------|
| 行业分析 | 40-60分钟 | 信息收集、报告生成 |
| 公司批量分析 | 30-90分钟 | 取决于公司数量和并行度 |
| 链接更新 | 2-5分钟 | 自动化处理 |
| 概念池更新 | 5-10分钟 | 批量添加股票 |
| **总计** | **1.5-3小时** | 全自动化执行 |

---

## 执行阶段详解

### 阶段1: 行业分析

#### 1.1 公司识别与分类

**识别标准**：
- 该公司主营业务与该行业直接相关
- 在A股上市（包括主板、创业板、科创板、北交所）
- 有明确的市占率或产能数据
- 被主流券商研报提及

**分层级分类**：

| 层级 | 数量 | 入选标准 | 典型特征 |
|------|------|----------|----------|
| 第一梯队 | 5-7家 | 市占率前三 / 营收前五 / 技术领先 | 行业绝对龙头，品牌影响力强 |
| 第二梯队 | 8-12家 | 细分龙头 / 区域龙头 / 快速成长 | 有特色优势，业绩增速快 |
| 第三梯队 | 5-8家 | 新进入者 / 转型升级 / 技术突破 | 潜力大但风险高，需密切跟踪 |

**按细分领域分类**：

根据产业链环节或技术路线，将公司归入不同细分领域：
- 上游（资源开采）
- 中游（冶炼/制造）
- 下游（深加工/应用）

#### 1.2 生成行业报告

使用 `templates/industry-template.md` 生成标准化报告，特别注意：

- **第6章"A股投资标的全景"**：
  - 6.1 分层级分类（三个梯队）
  - 6.2 按细分领域分类
  - 6.3 公司综合对比矩阵
  - 6.4 投资标的选择建议

- **链接占位符**：
  - 在"详细分析"列使用占位符：`[📄 查看详情](../公司分析/[公司名称].md)`
  - 后续批量分析完成后自动更新

---

### 阶段2: 公司批量分析

#### 2.1 分批策略

**分批原则**：
- 按层级顺序：先龙头、后重要、再潜力
- 每批3-5家公司，避免资源过载
- 最多同时运行4个并行任务

**分批示例**（以有色金属行业为例）：

```
Batch 1（第一梯队龙头，5家）：
├─ Task 1: 紫金矿业 + 江西铜业 + 北方稀土
└─ Task 2: 洛阳钼业 + 中国铝业

Batch 2（第二梯队重要企业，10家）：
├─ Task 3: 天齐锂业 + 山东黄金 + 西部矿业
├─ Task 4: 华友钴业 + 盛和资源 + 云铝股份
├─ Task 5: 赣锋锂业 + 铜陵有色 + 云南铜业
└─ Task 6: 厦门钨业（单独）

Batch 3（第三梯队潜力企业，5家）：
├─ Task 7: 金钼股份 + 章源钨业 + 盛新锂能
└─ Task 8: 中金岭南 + 株冶集团
```

#### 2.2 并行任务执行

**使用 Task tool 创建并行任务**：

```python
# 伪代码示例
for batch in [batch1, batch2, batch3]:
    tasks = []
    for company_group in batch:
        task = Task(
            description=f"分析公司: {company_group}",
            prompt=f"""
            请使用 investment-analysis skill 的"一、公司分析"流程，
            为以下公司生成详细分析报告：
            
            公司列表：{company_group}
            
            要求：
            1. 使用 templates/company-template.md 模板
            2. 保存到 docs/公司分析/[公司名称].md
            3. 包含完整的7个章节
            4. 确保数据准确性和来源可靠性
            """,
            readonly=False,
            subagent_type="generalPurpose"
        )
        tasks.append(task)
    
    # 并行执行当前批次
    run_parallel(tasks)
```

#### 2.3 质量检查

每个公司报告生成后，自动检查：

✅ **必须包含的章节**：
- 公司简介（表格形式）
- 主营业务
- 财务与业绩
- 行业地位与产业链定位
- 投资亮点
- 风险提示
- 业绩预期与估值

✅ **必须有的数据**：
- 股票代码
- 最新年报财务数据
- 市占率或行业排名
- 至少2个信息来源

❌ **常见问题检查**：
- 是否有空白章节？
- 是否有占位符未填充（如"[待补充]"）？
- 是否缺少数据来源说明？
- 是否文件命名不规范？

---

### 阶段3: 链接更新

#### 3.1 扫描生成的公司报告

**扫描逻辑**：
```python
# 伪代码
def scan_company_reports(industry_report):
    companies = extract_companies_from_industry_report(industry_report)
    
    for company in companies:
        report_path = f"docs/公司分析/{company.name}.md"
        
        if file_exists(report_path):
            # 更新链接
            update_link_in_industry_report(
                industry_report,
                company.code,
                report_path
            )
        else:
            # 记录缺失
            log_missing_report(company)
```

#### 3.2 更新行业报告链接

**替换占位符**：
- 从：`[📄 查看详情](../公司分析/[公司名称].md)`
- 到：`[📄 查看详情](../公司分析/紫金矿业.md)`

**添加完成标记**：

在行业报告末尾添加：

```markdown
---

## ✅ 分析完成状态

| 分析阶段 | 状态 | 完成时间 |
|----------|------|----------|
| 行业分析 | ✅ 已完成 | 2026-02-27 |
| 公司分析 | ✅ 已完成（共XX家） | 2026-02-27 |
| 概念池更新 | ✅ 已完成 | 2026-02-27 |

**公司分析报告列表**：
- [紫金矿业](../公司分析/紫金矿业.md)
- [江西铜业](../公司分析/江西铜业.md)
- ...
```

---

### 阶段4: 概念池更新

#### 4.1 提取公司-概念关系

**提取逻辑**：

根据行业报告和公司报告，确定：

| 字段 | 提取来源 | 示例 |
|------|----------|------|
| 股票代码 | 行业报告 | 601899 |
| 股票名称 | 行业报告 | 紫金矿业 |
| 概念名称 | 行业类别 | 有色金属 > 铜矿开采 |
| 标的类型 | 公司市占率 | 核心标的（市占率15%） |
| 归属逻辑 | 公司主营 | 全球铜金龙头，储量丰富成本低 |
| 信息来源 | 分析报告 | 行业分析报告+公司分析报告 |

#### 4.2 概念归属判定

**核心标的判定**（满足3项及以上）：
- 该业务营收占比 > 50%
- 市占率排名前3
- 拥有核心技术/专利壁垒
- 行业研报频繁提及为龙头

**相关标的判定**：
- 有该业务但非主营（占比 < 50%）
- 市占率排名靠后
- 转型中或布局中

#### 4.3 批量更新概念池

**更新流程**：

1. 读取 `docs/概念股票池体系.md`
2. 定位到相应概念章节
3. 批量插入股票信息：

```markdown
| 股票代码 | 股票名称 | 标的类型 | 归属逻辑 | 信息来源 | 验证状态 |
|---------|---------|---------|---------|---------|---------|
| 601899 | 紫金矿业 | ✅ 核心标的 | 全球铜金龙头，储量丰富成本低 | 行业分析+公司分析 | ✅ 已验证 |
```

4. 保存文件
5. 记录更新日志

---

## 并行处理配置

### 资源分配策略

| 配置项 | 默认值 | 说明 | 调整建议 |
|--------|--------|------|----------|
| 最大并行任务数 | 4 | 同时运行的Task数量 | API限制较紧时降到2-3 |
| 每批公司数 | 3-5家 | 每个Task分析的公司数 | 复杂公司减少到2-3家 |
| 任务超时 | 15分钟/公司 | 单个公司分析超时时间 | 简单公司可降到10分钟 |
| 失败重试 | 最多2次 | 失败后的重试次数 | 网络不稳定时增加到3次 |
| 批次间隔 | 10秒 | 两批任务之间的等待时间 | API有速率限制时增加 |

### 性能优化建议

**1. 根据公司复杂度调整**：
- 龙头企业（业务复杂）：2-3家/批
- 重要企业（中等复杂度）：3-4家/批
- 潜力企业（相对简单）：4-5家/批

**2. 根据网络状况调整**：
- 网络稳定：并行度4，每批5家
- 网络一般：并行度3，每批3-4家
- 网络不稳：并行度2，每批2-3家

**3. 根据API限制调整**：
- 无限制：并行度4，批次间隔5秒
- 有限制：并行度2-3，批次间隔20-30秒

---

## 错误处理与重试

### 常见错误类型

#### 错误1: 信息收集失败

**现象**：无法找到公司的财务数据或行业信息

**处理**：
1. 尝试替代数据源（东方财富、同花顺、Wind）
2. 降低数据完整性要求（仅提供核心指标）
3. 标注"数据不完整"并记录原因
4. 继续执行，不阻塞整体流程

#### 错误2: Web搜索超时

**现象**：搜索请求超时或无响应

**处理**：
1. 自动重试（最多2次）
2. 切换搜索关键词（更具体或更宽泛）
3. 如仍失败，记录日志，跳过该公司
4. 在最终报告中标注"分析失败"

#### 错误3: 文件保存失败

**现象**：无法写入文件或路径不存在

**处理**：
1. 检查文件路径是否存在，不存在则创建
2. 检查文件名是否包含特殊字符，自动清理
3. 重试保存
4. 如仍失败，使用临时文件名保存

#### 错误4: 并行任务崩溃

**现象**：某个Task异常终止

**处理**：
1. 记录崩溃的Task ID和公司列表
2. 其他Task继续执行（不影响）
3. 批次完成后，单独重新执行崩溃的Task
4. 如重试仍失败，人工介入

### 重试策略

**指数退避重试**：
```python
# 伪代码
def retry_with_backoff(func, max_retries=2):
    for i in range(max_retries + 1):
        try:
            return func()
        except Exception as e:
            if i == max_retries:
                log_error(e)
                return None
            wait_time = 2 ** i  # 1秒, 2秒, 4秒...
            time.sleep(wait_time)
```

### 失败记录

**记录格式**：

```markdown
# 批量分析失败记录

日期：2026-02-27
行业：有色金属

## 失败公司列表

| 公司代码 | 公司名称 | 失败原因 | 重试次数 | 处理状态 |
|---------|---------|---------|---------|---------|
| 600362 | 江西铜业 | Web搜索超时 | 2 | 待人工补充 |
| 603993 | 洛阳钼业 | 数据源缺失 | 2 | 已跳过 |
```

---

## 质量控制标准

### 报告完整性检查

**自动检查清单**：

- [ ] 文件命名规范（公司简称.md）
- [ ] 包含完整的7个章节
- [ ] 公司简介表格完整（8个必填项）
- [ ] 财务数据有来源说明
- [ ] 至少有3个信息来源引用
- [ ] 风险提示不为空
- [ ] 更新日期正确
- [ ] 免责声明存在

### 数据准确性检查

**关键数据验证**：

| 数据项 | 验证方法 | 容错范围 |
|--------|----------|----------|
| 股票代码 | 6位数字 | 不容错 |
| 营收数据 | 数量级合理性 | ±20% |
| 市占率 | 0-100% | 不容错 |
| 毛利率 | -100% ~ +100% | 不容错 |
| 日期格式 | YYYY-MM-DD | 不容错 |

### 人工复核建议

**需要人工复核的情况**：

1. 第一梯队龙头企业（业务复杂，影响大）
2. 数据源之间存在严重冲突（差异>30%）
3. 公司近期有重大重组或变化
4. 自动分析标注为"低可信度"的报告

**复核重点**：
- 财务数据准确性
- 行业地位描述客观性
- 投资亮点是否有数据支撑
- 风险提示是否全面

---

## 📝 附录

### A. 常用工具函数

```python
# 示例：提取公司代码
def extract_company_codes(industry_report_path):
    """从行业报告中提取所有公司代码"""
    # 实现逻辑
    pass

# 示例：检查报告完整性
def check_report_completeness(company_report_path):
    """检查公司报告是否包含所有必需章节"""
    # 实现逻辑
    pass
```

### B. 配置文件模板

```yaml
# batch-analysis-config.yaml
parallel:
  max_tasks: 4
  batch_size: [3, 5]  # min, max
  timeout_per_company: 900  # 15 minutes
  max_retries: 2
  batch_interval: 10  # seconds

quality_control:
  auto_check: true
  require_human_review: ["tier1"]  # 需要人工复核的层级
  
error_handling:
  retry_strategy: "exponential_backoff"
  log_failures: true
  continue_on_error: true
```

---

> **更新日期**：2026-02-27
> 
> **版本**：v1.0
> 
> **适用范围**：所有行业的批量公司分析
