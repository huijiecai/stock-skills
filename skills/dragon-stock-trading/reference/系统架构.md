# 系统架构文档

本文档说明龙头战法数据系统的整体架构和模块关系。

---

## 系统概览

龙头战法数据系统是一个支持短线龙头战法选股的数据采集、存储和分析平台。

**核心目标**：
- 提供6类数据查询能力，支持龙头战法决策
- 自动化数据采集和处理
- 为 LLM 提供结构化的查询接口

---

## 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                      用户层                              │
│  (通过 Cursor/AI 与系统交互)                            │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                   SKILL 层                               │
│  - 高层功能描述                                          │
│  - 用户交互接口                                          │
│  - 调用 reference 获取技术细节                          │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                Reference 层                              │
│  - 龙头战法理论 (理论模型)                              │
│  - 数据查询API (查询方法)                               │
│  - 数据库设计 (表结构)                                  │
│  - 概念配置指南 (配置维护)                              │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                  Scripts 层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ market_      │  │ concept_     │  │ query_       │  │
│  │ fetcher      │  │ manager      │  │ service      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ stock_       │  │ history_     │  │ db_init      │  │
│  │ fetcher      │  │ sync         │  │              │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│                   Data 层                                │
│  ┌──────────────┐          ┌──────────────┐            │
│  │ dragon_      │          │ concepts.    │            │
│  │ stock.db     │          │ json         │            │
│  │ (SQLite)     │          │ (配置文件)   │            │
│  └──────────────┘          └──────────────┘            │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│              External API 层                             │
│  - itick API (股票行情)                                  │
│  - 指数数据                                              │
└─────────────────────────────────────────────────────────┘
```

---

## 模块说明

### 1. SKILL 层

**文件**: `SKILL.md`

**职责**:
- 提供用户可见的功能描述
- 定义交互方式和使用场景
- 引导 LLM 查找技术文档

**设计原则**:
- 保持简洁，只描述"做什么"，不描述"怎么做"
- 将技术实现细节放在 reference/ 中
- 让 LLM 根据需求自动查找 reference

---

### 2. Reference 层

**目录**: `reference/`

**职责**:
- 存放技术文档和实现细节
- 提供数据查询方法说明
- 说明理论模型和决策标准

**文档清单**:
| 文档 | 内容 |
|------|------|
| 龙头战法理论.md | 预期管理、情绪拐点、4大模式 |
| 数据库设计.md | 表结构、字段说明、关系设计（已移至 `../../backend/数据库设计.md`） |
| 概念配置指南.md | concepts.json 维护方法、标准 |
| 系统架构.md | 本文档 |

**设计原则**:
- 详细、技术性
- 面向 LLM 和开发者
- 独立可查阅

---

### 3. Scripts 层

**目录**: `scripts/`

**职责**:
- 实现数据采集、处理、查询功能
- 提供 Python API 接口
- 可独立运行的命令行工具

**模块清单**:

#### 基础设施模块
- **config_loader.py** - 统一配置管理器（单例模式）
  - 加载 config.yaml
  - 环境变量替换
  - 提供配置查询接口
  
- **itick_client.py** - ITick API 客户端封装
  - 统一所有 API 调用
  - 自动速率限制（~20 请求/秒）
  - 统一错误处理和重试
  - 请求计数和监控

#### 数据采集模块
- **market_fetcher.py** - 市场数据采集器
  - 批量获取股票日行情
  - 计算市场情绪指标
  - 判断涨停/跌停状态
  - 计算连板天数

- **history_sync.py** - 历史数据同步（可选）
  - 批量同步K线数据
  - 补充历史缺失数据

#### 数据管理模块
- **concept_manager.py** - 概念管理器
  - 加载 concepts.json 配置
  - 计算概念日统计
  - 管理概念-股票关系

- **db_init.py** - 数据库初始化
  - 创建表结构
  - 初始化索引
  - 重置数据库

#### 数据查询模块
- **query_service.py** - 查询服务
  - 提供6类数据查询接口
  - 格式化输出
  - 支持组合查询

---

### 4. Data 层

**目录**: `data/`

**职责**:
- 存储所有本地数据
- 提供持久化能力

**数据文件**:

#### dragon_stock.db（SQLite数据库）
| 表名 | 用途 |
|------|------|
| market_sentiment | 市场情绪日统计 |
| stock_daily | 个股日行情 |
| stock_info | 股票基本信息 |
| stock_concept | 概念-股票关系 |
| concept_daily | 概念日统计 |
| stock_events | 异动记录 |

#### concepts.json（概念配置）
- JSON格式配置文件
- 定义概念与股票的关系
- 区分核心标的和相关标的
- 手工维护

---

## 配置管理

### 配置文件

配置文件 `config.yaml` 位于项目根目录：

```yaml
data:
  db_path: "./data/dragon_stock.db"
  cache_days: 10  # 保留最近N天数据
  
itick:
  api_key: "${ITICK_API_KEY}"  # 从环境变量读取
  base_url: "https://api.itick.io"
  timeout: 10
  
limit_up:
  # 涨停阈值（允许0.1%误差）
  main_board: 0.099      # 主板/中小板 10%
  growth_board: 0.199    # 创业板/科创板 20%
  st_stock: 0.049        # ST股票 5%
```

### 使用配置加载器

所有脚本统一通过 `config_loader` 访问配置：

```python
from config_loader import config

# 获取数据库路径
db_path = config.get_db_path()

# 获取 API 密钥
api_key = config.get_itick_api_key()

# 获取涨停阈值
main_threshold = config.get_limit_up_threshold('main_board')
```

### 使用 ITick API 客户端

所有 ITick API 调用统一使用 `itick_client`：

```python
from itick_client import ItickClient

# 创建客户端实例（自动从配置加载）
client = ItickClient()

# 获取实时行情
quote = client.get_stock_quote('000001', 'SZ')

# 获取 K 线数据
klines = client.get_stock_kline('000001', 'SZ', period='day', count=100)

# 获取股票详细信息
info = client.get_stock_info('000001', 'SZ')

# 客户端内置：
# - 自动速率限制（~20 请求/秒）
# - 统一错误处理
# - 请求计数和监控
```

---

## 数据流转

### 每日数据采集流程

```
1. 早盘准备（8:30前）
   ↓
   运行: python concept_manager.py
   加载最新概念配置

2. 收盘后采集（15:30后）
   ↓
   运行: python market_fetcher.py 2026-02-25
   ├─ 采集全市场行情 → stock_daily 表
   ├─ 计算市场情绪 → market_sentiment 表
   └─ 识别涨停/连板

3. 概念统计（采集后）
   ↓
   运行: python concept_manager.py 2026-02-25
   计算概念板块数据 → concept_daily 表

4. 查询使用（任意时间）
   ↓
   LLM 通过 query_service 查询数据
```

### LLM 查询流程

```
用户: "分析巨力索具是否符合龙头战法"
  ↓
LLM 理解需求
  ↓
查看 SKILL.md 确认功能
  ↓
查看 reference/龙头战法理论.md 了解判断标准
  ↓
查看 `../../backend/数据库设计.md` 了解数据表结构
  ↓
调用 query_service API 获取数据
  ├─ get_market_status() → 市场情绪
  ├─ get_stock_with_concept() → 个股信息
  ├─ get_stock_popularity_rank() → 人气排名
  └─ get_concept_stats() → 概念统计
  ↓
按照龙头战法标准分析
  ├─ 人气底线: 成交额排名
  ├─ 逻辑正宗: 概念归属
  ├─ 地位突出: 连板/领涨
  └─ 市场状态: 冰点/主升
  ↓
给出分析结果和操作建议
```

---

## 接口设计

### QueryService API

```python
# 初始化
service = QueryService("data/dragon_stock.db")

# 6类数据查询
market = service.get_market_status(date)              # 市场情绪
stock = service.get_stock_with_concept(code, date)    # 个股全景
popularity = service.get_stock_popularity_rank(date, 30) # 人气榜
leaders = service.get_concept_leaders(date, min_limit_up=1) # 概念龙头
history = service.get_stock_history(code, days=10)    # 历史走势
sequence = service.check_limit_up_sequence(concept, date) # 涨停时序

# 格式化输出
service.format_market_status(market)
service.format_stock_info(stock)
```

### ConceptManager API

```python
# 初始化
manager = ConceptManager("data/dragon_stock.db")

# 概念管理
manager.load_concept_config("data/concepts.json")     # 加载配置
manager.calculate_concept_daily(date)                 # 计算统计

# 概念查询
stats = manager.get_concept_stats(concept, date)      # 概念统计
stocks = manager.get_concept_stocks(concept)          # 概念股票
concepts = manager.get_stock_concepts(stock_code)     # 股票概念
```

---

## 扩展性设计

### 1. 新增数据源

如需新增数据源（如龙虎榜、资金流向）：

```
1. 在 scripts/ 中创建新的 fetcher
2. 在 db_init.py 中添加新表
3. 在 query_service.py 中添加查询方法
4. 在后端 API 文档中补充说明
```

### 2. 新增概念

直接编辑 `data/concepts.json`，然后重新加载：

```bash
python concept_manager.py
```

### 3. 新增查询维度

在 `query_service.py` 中添加新方法，然后通过后端 API 暴露。

---

## 测试体系

### 单元测试

**文件**: `tests/test_basic_modules.py`

测试模块：
- 数据库初始化
- 概念管理器
- 查询服务

运行方式：
```bash
python tests/test_basic_modules.py
```

### 集成测试

**文件**: `tests/test_integration.py`

测试流程：
- 完整的数据采集→处理→查询流程
- 验证6类数据能力

运行方式：
```bash
python tests/test_integration.py
```

---

## 性能考虑

### 查询性能

- 所有关键字段已建立索引
- 单个查询响应时间 < 100ms
- 支持并发查询

### 采集性能

- itick API 有频率限制（约20 QPS）
- 全市场5000只股票需约4-5分钟
- 通过 sleep 控制请求速度

### 存储优化

- SQLite 单文件数据库
- 自动清理30天前数据
- 数据库大小 < 100MB（30天数据）

---

## 部署建议

### 开发环境

```bash
# 安装依赖
pip install requests

# 设置环境变量
export ITICK_API_KEY="your_key"

# 初始化
cd scripts && python db_init.py
```

### 生产环境

建议配置：
- 定时任务：每日15:30自动采集
- 数据备份：每周备份数据库
- 监控告警：采集失败时通知

---

## 常见问题

### Q: 为什么要分 SKILL 和 reference？

A: **职责分离**。SKILL 面向用户，描述功能；reference 面向 LLM，提供技术细节。LLM 根据需求自动查找 reference，而不是把所有技术细节都塞进 SKILL。

### Q: 数据如何保证准确性？

A: 
- 使用 itick API 获取实时数据
- 本地计算涨停状态、连板天数等衍生指标
- 概念配置需要手工维护确保准确

### Q: 如何处理缺失数据？

A: 
- 查询时返回 None 或空列表
- 历史数据通过每日采集逐步积累
- 首次使用时只有当日数据

### Q: 性能瓶颈在哪里？

A: 
- itick API 频率限制是主要瓶颈
- 全市场采集需要4-5分钟
- 单个查询性能足够快（< 100ms）
