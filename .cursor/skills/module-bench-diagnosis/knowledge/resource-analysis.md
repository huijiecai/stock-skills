# 资源监控分析指南

资源监控包括 CPU 使用率、CPU 内存、GPU 内存的门限检测。

---

## 1. CPU_MONITOR 分析

### 报告结构

```
======================================== CPU Monitor Report ========================================

┌─────────────────────────────────────────────────────────────────────────┐
│                         CPU USAGE SUMMARY                               │
├─────────────┬────────────┬────────────┬──────────┬──────────┬──────────┤
│ DrivingMode │   Module   │ Test Value │ Baseline │ Increase │ Threshold│
├─────────────┼────────────┼────────────┼──────────┼──────────┼──────────┤
│ DRIVING     │ perception │     85%    │   70%    │   +15%   │   10%    │ ❌ FAIL
│ DRIVING     │ planning   │     45%    │   40%    │    +5%   │   10%    │ ✅ PASS
└─────────────┴────────────┴────────────┴──────────┴──────────┴──────────┘
```

### 搜索命令

```bash
grep "CPU Monitor" <log> -A 30
```

### 常见失败原因

| 原因 | 验证方法 | 解决方案 |
|------|---------|---------|
| 算法复杂度增加 | 检查相关函数变更 | 优化算法 |
| 新增计算模块 | 检查新增功能 | 确认是否预期 |
| 循环逻辑变更 | 检查循环相关代码 | 优化循环效率 |
| 多线程问题 | 检查线程调度 | 优化线程分配 |

### 输出模板

```markdown
#### CPU Monitor 分析

| DrivingMode | 模块 | 测试值 | 基线值 | 增量 | 阈值 | 状态 |
|-------------|------|--------|--------|------|------|------|
| DRIVING | perception | 85% | 70% | +15% | 10% | ❌ FAIL |

**可能原因**：perception 模块算法复杂度增加
**建议操作**：检查 perception 近期 commit，联系模块 owner
```

---

## 2. MEMGATE_GPU 分析

### 报告结构

```
======================================== GPU Memory Gate ========================================

┌───────────────────────────────────────────────────────────────────────────────────────────┐
│                                   GPU MEMORY SUMMARY                                       │
├─────────────┬──────────┬────────────┬────────────┬────────────┬───────────┬───────┬───────┤
│ DrivingMode │  Metric  │ Test Value │ Base Value │ Difference │ Threshold │ Unit  │Status │
├─────────────┼──────────┼────────────┼────────────┼────────────┼───────────┼───────┼───────┤
│ DRIVING     │ PEAK     │    9500.00 │    9308.73 │    +191.27 │    379.26 │   MB  │ FAIL  │
│ DRIVING     │ PROCESS  │    8200.00 │    8100.00 │    +100.00 │    200.00 │   MB  │ PASS  │
└─────────────┴──────────┴────────────┴────────────┴────────────┴───────────┴───────┴───────┘
```

### 搜索命令

```bash
grep "GPU Memory Gate" <log> -A 20
```

### 关键指标

| 指标 | 说明 |
|------|------|
| **PEAK** | GPU 显存峰值使用量 |
| **PROCESS** | GPU 进程显存使用量 |

### 常见失败原因

| 原因 | 验证方法 | 解决方案 |
|------|---------|---------|
| 新增 NN 模型 | 检查模型配置变更 | 优化模型大小或量化 |
| 模型更新 | 对比模型版本 | 确认是否预期增长 |
| 显存泄漏 | 多次运行观察增长 | 修复泄漏点 |
| Batch size 增大 | 检查推理配置 | 调整 batch size |

### 输出模板

```markdown
#### GPU Memory Gate 分析

| DrivingMode | 指标 | 测试值 | 基线值 | 增量 | 阈值 | 状态 |
|-------------|------|--------|--------|------|------|------|
| DRIVING | PEAK | 9500 MB | 9308 MB | +191 MB | 379 MB | ❌ FAIL |
| LOW_SPEED | PEAK | 8200 MB | 7800 MB | +400 MB | 350 MB | ❌ FAIL |

**可能原因**：新增/更新 NN 模型导致显存增加
**建议操作**：
1. 检查 NN 模型配置变更
2. 联系 NN 模块 owner
```

---

## 3. MEMGATE_CPU 分析

### 报告结构

```
======================================== CPU Memory Gate ========================================

┌───────────────────────────────────────────────────────────────────────────────────────────┐
│                                   CPU MEMORY SUMMARY                                       │
├─────────────┬──────────┬────────────┬────────────┬────────────┬───────────┬───────┬───────┤
│ DrivingMode │  Metric  │ Test Value │ Base Value │ Difference │ Threshold │ Unit  │Status │
├─────────────┼──────────┼────────────┼────────────┼────────────┼───────────┼───────┼───────┤
│ DRIVING     │ PEAK     │    4500.00 │    4200.00 │    +300.00 │    200.00 │   MB  │ FAIL  │
│ PARKING     │ PEAK     │    3800.00 │    3600.00 │    +200.00 │    250.00 │   MB  │ PASS  │
└─────────────┴──────────┴────────────┴────────────┴────────────┴───────────┴───────┴───────┘
```

### 搜索命令

```bash
grep "CPU Memory Gate" <log> -A 20
```

### 常见失败原因

| 原因 | 验证方法 | 解决方案 |
|------|---------|---------|
| 内存泄漏 | 多次运行观察增长趋势 | 使用 Valgrind 定位 |
| 大对象未释放 | 检查对象生命周期 | 及时释放不需要的对象 |
| 缓存策略变更 | 检查缓存相关代码 | 优化缓存大小 |
| 新增数据结构 | 检查新增功能 | 确认是否预期 |

### 输出模板

```markdown
#### CPU Memory Gate 分析

| DrivingMode | 指标 | 测试值 | 基线值 | 增量 | 阈值 | 状态 |
|-------------|------|--------|--------|------|------|------|
| DRIVING | PEAK | 4500 MB | 4200 MB | +300 MB | 200 MB | ❌ FAIL |

**可能原因**：内存泄漏或大对象未及时释放
**建议操作**：
1. 运行 Memcheck 检测内存泄漏
2. 检查近期新增的数据结构
```

---

## 通用分析流程

1. **定位失败项**：从报告中获取失败的 DrivingMode + Metric
2. **对比基线**：查看增量是否超过阈值
3. **检查代码变更**：查看相关模块的最近 commit
4. **判断原因类型**：模型更新 vs 泄漏 vs 预期增长
5. **提供建议**：联系对应模块 owner 或提供优化建议

