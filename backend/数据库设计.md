# 数据库设计文档

本文档说明龙头战法数据系统的数据库表结构。

## 数据库类型

SQLite 3.x，位于 `data/dragon_stock.db`

---

## 表结构

### 1. market_sentiment - 市场情绪日统计

记录每日市场整体情绪指标，用于判断市场阶段。

```sql
CREATE TABLE market_sentiment (
    trade_date TEXT PRIMARY KEY,      -- 交易日期 YYYY-MM-DD
    limit_up_count INTEGER,           -- 涨停家数
    limit_down_count INTEGER,         -- 跌停家数
    broken_board_count INTEGER,       -- 炸板家数
    max_streak INTEGER,               -- 最高连板数
    sh_index_change REAL,             -- 上证指数涨跌幅（小数）
    sz_index_change REAL,             -- 深证成指涨跌幅
    cy_index_change REAL,             -- 创业板指涨跌幅
    kc_index_change REAL,             -- 科创50涨跌幅
    total_turnover REAL,              -- 两市总成交额（亿元）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `trade_date`: 主键，交易日期
- `limit_up_count`: 当日涨停股票数量
- `limit_down_count`: 当日跌停股票数量
- `broken_board_count`: 当日炸板（涨停后开板）数量
- `max_streak`: 当日最高连板天数（如3表示有3连板股票）
- `sh_index_change`: 上证指数涨跌幅，小数格式
- `sz_index_change`: 深证成指涨跌幅，小数格式
- `cy_index_change`: 创业板指涨跌幅，小数格式
- `kc_index_change`: 科创50涨跌幅，小数格式
- `total_turnover`: 两市总成交额，单位亿元

**四大指数说明**:
| 指数名称 | 代码 | 字段 | 含义 |
|---------|------|------|------|
| 上证指数 | 000001.SH | sh_index_change | 主板大盘走势 |
| 深证成指 | 399001.SZ | sz_index_change | 深圳市场走势 |
| 创业板指 | 399006.SZ | cy_index_change | 创业板走势 |
| 科创50 | 000688.SH | kc_index_change | 科创板走势 |

---

### 2. stock_daily - 个股日行情

记录每只股票的日行情数据，包括价格、量能、涨停状态等。

```sql
CREATE TABLE stock_daily (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trade_date TEXT NOT NULL,         -- 交易日期
    stock_code TEXT NOT NULL,         -- 股票代码
    stock_name TEXT,                  -- 股票名称
    market TEXT,                      -- 市场 SH/SZ
    open_price REAL,                  -- 开盘价
    high_price REAL,                  -- 最高价
    low_price REAL,                   -- 最低价
    close_price REAL,                 -- 收盘价
    pre_close REAL,                   -- 昨收价
    change_amount REAL,               -- 涨跌额（元）
    change_percent REAL,              -- 涨跌幅（小数）
    volume INTEGER,                   -- 成交量（手）
    turnover REAL,                    -- 成交额（元）
    turnover_rate REAL,               -- 换手率（小数）
    is_limit_up INTEGER DEFAULT 0,   -- 是否涨停 1/0
    is_limit_down INTEGER DEFAULT 0,  -- 是否跌停 1/0
    limit_up_time TEXT,               -- 涨停时间 HH:MM:SS
    streak_days INTEGER DEFAULT 0,    -- 连板天数
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(trade_date, stock_code)
);

CREATE INDEX idx_stock_daily_date ON stock_daily(trade_date);
CREATE INDEX idx_stock_daily_code ON stock_daily(stock_code);
```

**字段说明**:
- `trade_date + stock_code`: 联合唯一键
- `change_percent`: 涨跌幅，小数格式（0.0585 = 5.85%）
- `volume`: 成交量，单位为手（1手=100股）
- `turnover`: 成交额，单位为元
- `is_limit_up/is_limit_down`: 布尔值，1表示是，0表示否
- `streak_days`: 连板天数，1=首板，2=二连板，以此类推
- `limit_up_time`: 涨停封板时间，格式 HH:MM:SS

**涨停判断规则**:
- 主板/中小板: `change_percent >= 0.099` (≥9.9%)
- 创业板/科创板: `change_percent >= 0.199` (≥19.9%)
- ST股票: `change_percent >= 0.049` (≥4.9%)

**数据采集规则**:
- **自动排除 ST 股票**：系统在数据采集时会自动跳过所有股票名称中包含 'ST' 的股票
- ST 股票包括：*ST、ST、S*ST、SST 等各种形式
- 原因：ST 股票风险较高，不符合龙头战法的选股标准

---

### 3. stock_intraday - 个股分时数据

记录股票盘中分时行情，用于分析涨停时机、封板强度、资金流向等关键信息。

```sql
CREATE TABLE stock_intraday (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trade_date TEXT NOT NULL,         -- 交易日期 YYYY-MM-DD
    stock_code TEXT NOT NULL,         -- 股票代码
    trade_time TEXT NOT NULL,         -- 交易时间 HH:MM:SS
    price REAL,                       -- 当前价
    change_percent REAL,              -- 涨跌幅（小数）
    volume INTEGER,                   -- 累计成交量（手）
    turnover REAL,                    -- 累计成交额（元）
    avg_price REAL,                   -- 均价
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(trade_date, stock_code, trade_time)
);

CREATE INDEX idx_intraday_date_code ON stock_intraday(trade_date, stock_code);
CREATE INDEX idx_intraday_time ON stock_intraday(trade_time);
```

**字段说明**:
- `trade_date + stock_code + trade_time`: 联合唯一键
- `trade_time`: 时间点（09:31, 09:32, ..., 15:00）
- `volume/turnover`: 累计值（当日从开盘到当前时间的累计）
- `change_percent`: 相对昨收价的涨跌幅
- `avg_price`: 均价线价格

**数据特征**:
- 每只股票/天：242 个数据点（每分钟1个）
- 交易时间：09:30-11:30（120分钟）+ 13:00-15:00（120分钟）
- 集合竞价不计入分时数据

**关键用途**:
1. **涨停时机判断**：早盘涨停（强） vs 尾盘涨停（弱）
2. **封板强度分析**：封板后是否开板、开板次数
3. **资金流向追踪**：盘中大单进出时间点
4. **情绪强度评估**：拉升速度、回调幅度
5. **形态识别**：一字板、T型板、N型板

**存储优化**:
- 只保留股票池内的股票（约150只）
- 历史数据保留30天（约100万条记录，~100MB）
- 超过30天自动清理
- 使用复合索引优化查询性能

**数据来源**:
- Tushare Pro 接口：`pro.stk_mins(ts_code='000001.SZ', freq='1min')`
- 需要 5000 积分权限

---

### 4. stock_info - 股票基本信息

记录股票的基本信息，如行业分类、上市日期等。

```sql
CREATE TABLE stock_info (
    stock_code TEXT PRIMARY KEY,      -- 股票代码
    stock_name TEXT,                  -- 股票名称
    market TEXT,                      -- 市场 SH/SZ
    board_type TEXT,                  -- 板块类型
    industry TEXT,                    -- 一级行业
    sub_industry TEXT,                -- 二级行业
    list_date TEXT,                   -- 上市日期
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明**:
- `stock_code`: 主键，6位股票代码
- `stock_name`: 股票名称
- `market`: 市场代码（SH=上海，SZ=深圳）
- `board_type`: 板块类型，用于区分涨停阈值
  - `主板` - 上海主板/深圳主板（10%涨停）
  - `创业板` - 创业板（20%涨停）
  - `科创板` - 科创板（20%涨停）
  - `北交所` - 北京证券交易所（30%涨停）
- `industry`: 一级行业分类（如"电子制造"）
- `sub_industry`: 二级行业分类（如"消费电子"）
- `list_date`: 上市日期 YYYY-MM-DD

**板块识别规则**:
```python
def get_board_type(stock_code: str) -> str:
    """根据股票代码判断板块类型"""
    if stock_code.startswith('688'):
        return '科创板'
    elif stock_code.startswith('300') or stock_code.startswith('301'):
        return '创业板'
    elif stock_code.startswith('8') or stock_code.startswith('4'):
        return '北交所'
    else:
        return '主板'
```

**涨停阈值对应关系**:
| 板块类型 | 代码前缀 | 涨停阈值 | 跌停阈值 |
|---------|---------|---------|---------|
| 主板 | 000/001/002/600/601/603 | 10% | -10% |
| 创业板 | 300/301 | 20% | -20% |
| 科创板 | 688 | 20% | -20% |
| 北交所 | 8/4 | 30% | -30% |
| ST股票 | 名称含ST | 5% | -5% |

---

### 5. stock_concept - 概念题材配置

维护股票与概念的多对多关系，支持核心标的标识。

```sql
CREATE TABLE stock_concept (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_code TEXT NOT NULL,         -- 股票代码
    concept_name TEXT NOT NULL,       -- 概念名称
    is_core INTEGER DEFAULT 0,        -- 是否核心标的 1/0
    note TEXT,                        -- 备注说明
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(stock_code, concept_name)
);

CREATE INDEX idx_concept_stock ON stock_concept(stock_code);
CREATE INDEX idx_concept_name ON stock_concept(concept_name);
```

**字段说明**:
- `stock_code + concept_name`: 联合唯一键
- `is_core`: 1=核心标的，0=相关标的
- `note`: 备注信息（如"核心标的"、"相关标的"）

**数据来源**: 从 `data/concepts.json` 配置文件加载

---

### 6. concept_daily - 概念日统计

记录每日各概念板块的统计数据，用于板块强度分析。

```sql
CREATE TABLE concept_daily (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    trade_date TEXT NOT NULL,         -- 交易日期
    concept_name TEXT NOT NULL,       -- 概念名称
    stock_count INTEGER,              -- 概念内个股数
    limit_up_count INTEGER,           -- 涨停家数
    avg_change REAL,                  -- 平均涨幅（小数）
    total_turnover REAL,              -- 板块总成交额（亿元）
    leader_code TEXT,                 -- 领涨股代码
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(trade_date, concept_name)
);
```

**字段说明**:
- `trade_date + concept_name`: 联合唯一键
- `stock_count`: 该概念包含的股票数量
- `limit_up_count`: 当日涨停的股票数量
- `avg_change`: 板块平均涨幅，小数格式
- `total_turnover`: 板块总成交额，单位亿元
- `leader_code`: 领涨股代码（涨幅最大的股票）

**计算逻辑**: 
- 通过 `stock_concept` 关联 `stock_daily` 计算
- 每日运行 `concept_manager.py` 更新

---

### 7. stock_events - 异动记录

记录股票的重要事件，如监管问询、重大公告等。

```sql
CREATE TABLE stock_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    stock_code TEXT NOT NULL,         -- 股票代码
    event_date TEXT NOT NULL,         -- 事件日期
    event_type TEXT,                  -- 事件类型
    event_desc TEXT,                  -- 事件描述
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_events_code ON stock_events(stock_code);
```

**字段说明**:
- `event_type`: 事件类型（"监管"、"异动"、"公告"等）
- `event_desc`: 事件详细描述

**使用场景**: 
- 记录龙头股的监管问询
- 记录重大利好/利空公告
- 用于龙头战法的"逻辑证伪"判断

---

## 数据关系

```
stock_info (1) ←→ (N) stock_daily
    ↓
stock_concept (N) ←→ (N) concept_daily
    ↓
stock_events (N)

market_sentiment (独立)
```

**关系说明**:
- 一只股票（`stock_info`）有多条日行情（`stock_daily`）
- 一只股票可以属于多个概念（`stock_concept`）
- 一个概念包含多只股票
- 每个概念每日有一条统计（`concept_daily`）

---

## 初始化

```bash
cd scripts
python db_init.py
```

创建所有表结构和索引。

---

## 数据流转

### 每日数据采集流程

```
1. market_fetcher.py
   ↓ 采集全市场行情
   → stock_daily 表

2. market_fetcher.py
   ↓ 计算市场情绪
   → market_sentiment 表

3. concept_manager.py
   ↓ 计算概念统计
   → concept_daily 表
```

### 查询流程

```
query_service.py
   ↓ 读取数据
   ← stock_daily
   ← stock_concept
   ← concept_daily
   ← market_sentiment
   ↓ 返回结果
```

---

## 数据维护

### 清理旧数据

```sql
-- 删除30天前的日行情
DELETE FROM stock_daily 
WHERE trade_date < date('now', '-30 days');

-- 删除30天前的市场情绪
DELETE FROM market_sentiment 
WHERE trade_date < date('now', '-30 days');

-- 删除30天前的概念统计
DELETE FROM concept_daily 
WHERE trade_date < date('now', '-30 days');
```

### 备份数据库

```bash
# 备份
cp data/dragon_stock.db data/dragon_stock_backup_$(date +%Y%m%d).db

# 恢复
cp data/dragon_stock_backup_20260225.db data/dragon_stock.db
```

---

## 性能优化

### 已创建的索引

- `idx_stock_daily_date`: 按日期查询
- `idx_stock_daily_code`: 按股票代码查询
- `idx_concept_stock`: 按股票查概念
- `idx_concept_name`: 按概念查股票
- `idx_events_code`: 按股票查事件

### 查询优化建议

1. 尽量使用日期范围查询而非全表扫描
2. 查询时指定 `trade_date` 或 `stock_code`
3. 批量查询时使用 `IN` 子句而非多次单独查询

```sql
-- 好的查询
SELECT * FROM stock_daily 
WHERE trade_date = '2026-02-25' 
AND stock_code IN ('000001', '000002', '000003');

-- 避免的查询
SELECT * FROM stock_daily; -- 全表扫描
```
